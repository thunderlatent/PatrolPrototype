<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的紀錄 - 安全室巡檢系統</title>
    <script>
        // 檢查是否在 iframe 內訪問
        if (window.self === window.top) {
            // 直接訪問時重定向到 iPhone 框架視圖並在其底部導航欄選擇「我的紀錄」
            window.location.href = 'iphone-view.html';
            // 註：因為無法使用查詢參數，我們將依靠用戶點擊底部的「我的紀錄」按鈕
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        /* 路線卡片修復樣式 */
        .route-cards {
            margin-bottom: 1rem;
        }
        
        .route-cards .card {
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 0.75rem;
        }
        
        .border-l-4 {
            border-left-width: 4px;
        }
        
        .border-blue-500 {
            border-left-color: #3b82f6;
        }
        
        .border-green-500 {
            border-left-color: #10b981;
        }
        
        .border-yellow-500 {
            border-left-color: #f59e0b;
        }
        
        .border-gray-400 {
            border-left-color: #9ca3af;
        }
        
        /* 時間段標題修復 */
        .time-slot-header {
            background-color: #f0f7ff;
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            font-weight: 600;
            color: #1e40af;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .time-slot-header h3 {
            margin: 0;
            padding: 0;
            font-size: 1rem;
        }
        
        /* 頁面基本樣式 */
        .page-container {
            padding: 60px 20px 120px 20px; /* 上方增加間距避開動態島，底部增加間距避開底部導航 */
            height: 100%;
            max-width: 430px; /* 調整為 iPhone 16 Pro Max 寬度 */
            margin: 0 auto;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }
        
        /* 頁面標題區域樣式 */
        .page-title-container {
            margin-bottom: 20px;
            padding-bottom: 12px;
        }
        
        .page-title {
            font-size: 26px;
            font-weight: 700;
            color: #1c1c1e;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .page-title .title-icon {
            margin-right: 10px;
            width: 32px;
            height: 32px;
            background-color: #ebf5ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            font-size: 16px;
        }
        
        .page-subtitle {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            align-items: center;
        }
        
        .page-subtitle .user-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            color: #4b5563;
            font-size: 12px;
        }
        
        /* 日曆區域 */
        .calendar-section {
            background-color: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .calendar {
            margin-bottom: 16px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            background-color: #3b82f6;
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95rem;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            background-color: #ffffff;
        }
        
        .day-name {
            font-size: 12px;
            color: #6b7280;
            padding: 8px 0;
        }
        
        .day {
            padding: 12px 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .day:hover {
            background-color: #f3f4f6;
        }
        
        .day.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        
        .day.today {
            font-weight: bold;
            border: 2px solid #3b82f6;
        }
        
        /* 有記錄的日期添加圓點指示器 */
        .day.has-record:after {
            content: "";
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #3b82f6;
            border-radius: 50%;
        }
        
        /* 選中日期顯示 */
        #selectedDate {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
            padding: 8px 0;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* 導航欄樣式 */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #4b5563;
        }
        
        /* 日曆樣式 */
        .calendar-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .nav-button {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-button:hover {
            background-color: #f3f4f6;
            color: #3b82f6;
        }
        
        .month-year {
            font-size: 16px;
            font-weight: 600;
            margin: 0 15px;
            color: #1f2937;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }
        
        .day:not(.empty):hover {
            background-color: #f3f4f6;
        }
        
        .day.today {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        
        .day.selected {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        
        .day.has-record:after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 4px;
            height: 4px;
            background-color: #3b82f6;
            border-radius: 50%;
        }
        
        .day.today.has-record:after {
            background-color: white;
        }
        
        /* 統計卡片樣式 */
        .stats-card {
            background-color: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .progress-container {
            background-color: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 4px;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .stats-numbers {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* 記錄列表樣式 */
        .records-list {
            margin-bottom: 70px; /* 為底部導航欄留出空間 */
        }
        
        .no-records-message {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
        }
        
        .no-records-message i {
            font-size: 32px;
            margin-bottom: 12px;
            color: #d1d5db;
        }
        
        /* 底部導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            color: #6b7280;
            text-decoration: none;
            font-size: 10px;
        }
        
        .nav-item i {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .nav-item.active {
            color: #3b82f6;
        }
        
        /* 上傳狀態標籤樣式 */
        .upload-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        }
        
        .status-uploaded {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .status-not-uploaded {
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .status-incomplete {
            background-color: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        /* 卡片狀態樣式 */
        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        /* 上傳按鈕樣式 */
        .bg-blue-500 {
            background-color: #3b82f6;
        }
        
        .hover\:bg-blue-600:hover {
            background-color: #2563eb;
        }
        
        .text-white {
            color: white;
        }
        
        .rounded {
            border-radius: 0.25rem;
        }
        
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        /* 上傳時間樣式 */
        .upload-time {
            font-size: 11px;
            opacity: 0.85;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: normal;
        }
        
        /* 檢查點項目樣式 */
        .checkpoint-item {
            transition: all 0.2s ease;
        }
        
        .checkpoint-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }
        
        /* 圖片查看器 */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .image-viewer.active {
            opacity: 1;
            pointer-events: all;
        }
        .image-viewer img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-viewer .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        
        /* 全屏圖片視圖 */
        .form-overlay,
        .fullscreen-image-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .fullscreen-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* 上傳按鈕樣式 */
        .upload-button {
            transition: all 0.3s ease;
        }
        
        .upload-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .upload-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }
        
        /* 響應式調整 */
        @media (max-width: 375px) {
            .days-grid {
                gap: 4px;
            }
            
            .day {
                height: 32px;
                font-size: 13px;
            }
        }
        
        /* 進度條樣式修正 */
        .progress-container {
            background-color: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 4px;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        /* 修正卡片樣式 */
        .bg-white {
            background-color: #ffffff;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .overflow-hidden {
            overflow: hidden;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .mr-3 {
            margin-right: 0.75rem;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .mt-3 {
            margin-top: 0.75rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-green-600 {
            color: #059669;
        }
        
        .bg-gray-50 {
            background-color: #f9fafb;
        }
        
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .border-t {
            border-top-width: 1px;
        }
        
        .border-gray-100 {
            border-color: #f3f4f6;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="page-container">
        <!-- 頁面標題 -->
        <div class="page-title-container">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div>我的巡查紀錄</div>
            </div>
            <div class="page-subtitle">
                <div class="user-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div id="userInfo">警衛 #12345</div>
            </div>
        </div>
        
        <!-- 主要內容區 - 日曆和記錄 -->
        <div id="mainContent">
            <!-- 日曆區域 -->
            <div class="calendar-section mb-6 fade-in-up" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-800">選擇日期</h2>
                    <button id="todayBtn" class="px-3 py-1.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-all flex items-center">
                        <i class="fas fa-calendar-day mr-1.5"></i>今天
                    </button>
                </div>
                <div class="calendar mb-6">
                    <div class="calendar-header">
                        <div class="flex justify-between items-center">
                            <button id="prevMonth" class="text-white hover:bg-blue-600 p-1 rounded-full transition-all">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div id="currentMonth" class="tracking-wide">2025年3月</div>
                            <button id="nextMonth" class="text-white hover:bg-blue-600 p-1 rounded-full transition-all">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- 日曆內容由 JavaScript 填充 -->
                    </div>
                </div>
                
                <!-- 選中日期顯示 -->
                <div id="selectedDate" class="text-lg font-bold flex items-center mb-4">
                    <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                    <span>2025年3月17日（週一）</span>
                </div>
            </div>
            
            <!-- 統計卡片 -->
            <div id="statsCard" class="stats-card mb-6 fade-in-up" style="animation-delay: 0.2s;">
                <div class="flex justify-between items-center mb-3">
                    <div class="text-gray-600">今日完成進度</div>
                    <div class="font-bold text-lg" id="progressPercentage">0%</div>
                </div>
                <div class="bg-gray-200 h-2 rounded-full overflow-hidden">
                    <div class="bg-blue-500 h-full" id="progressBar" style="width: 0%;"></div>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 mb-1" id="totalCount">0</div>
                        <div class="text-xs text-gray-500">今日總巡查</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-emerald-600 mb-1" id="completedCount">0</div>
                        <div class="text-xs text-gray-500">已完成</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600 mb-1" id="pendingCount">0</div>
                        <div class="text-xs text-gray-500">未完成</div>
                    </div>
                </div>
            </div>
            
            <!-- 記錄列表 -->
            <div id="recordsList" class="fade-in-up" style="animation-delay: 0.3s;">
                <!-- 記錄卡片由 JavaScript 產生 -->
            </div>
            
            <!-- 無記錄提示 -->
            <div id="noRecords" class="text-center py-10 text-gray-500 hidden fade-in-up" style="animation-delay: 0.3s;">
                <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                <div class="text-lg font-medium">當日無巡查記錄</div>
                <div class="text-sm mt-2">請選擇其他日期查看</div>
            </div>
        </div>
        
        <!-- 詳情頁面 -->
        <div id="routeDetailsContent" class="hidden">
            <!-- 詳情頁面頂部導航 -->
            <div class="mb-4">
                <button id="backToRecordsBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-lg flex items-center text-sm">
                    <i class="fas fa-arrow-left mr-2"></i>返回記錄列表
                </button>
            </div>
            
            <!-- 路線詳情卡片 -->
            <div id="routeDetailsCard" class="bg-white rounded-lg shadow-sm mb-5 overflow-hidden">
                <div class="p-4">
                    <div id="routeDetailHeader"></div>
                </div>
            </div>
            
            <!-- 檢查點列表 -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">檢查點列表</h3>
                <div id="checkpointsList" class="space-y-3">
                    <!-- 檢查點由 JavaScript 填充 -->
                </div>
            </div>
            
            <!-- 上傳按鈕區域 -->
            <div id="uploadBtnArea" class="mt-6 mb-4">
                <!-- 上傳按鈕由 JavaScript 填充 -->
            </div>
        </div>
    </div>

    <!-- 圖片查看器 -->
    <div class="image-viewer" id="imageViewer">
        <div class="close-button" onclick="closeImageViewer()">
            <i class="fas fa-times"></i>
        </div>
        <img id="viewerImage" src="" alt="圖片查看">
    </div>

    <script>
        // 全局變數
        let selectedDate = '2025-03-24'; // 預設為2025年3月24日 (YYYY-MM-DD)
        
        // 日曆變數
        let currentYear = 2025; // 預設年份
        let currentMonth = 2;   // 預設月份 (0-based index)，即3月
        
        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            // 更新當前登入用戶信息
            updateUserInfo();
            
            // 初始化日曆
            updateCalendar();
            
            // 顯示今天的記錄（實際上是基於localStorage的路線數據）
            updateRecords(selectedDate);
            
            // 今天按鈕點擊
            document.getElementById('todayBtn').addEventListener('click', function() {
                selectedDate = '2025-03-24'; // 固定設為 3月24日
                currentYear = 2025;
                currentMonth = 2; // 3月 (0-based)
                
                // 更新日曆
                updateCalendar();
                
                // 更新記錄
                updateRecords(selectedDate);
            });
            
            // 月份導航
            document.getElementById('prevMonth').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendar();
            });
            
            document.getElementById('nextMonth').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendar();
            });
        });
        
        // 格式化日期顯示
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            
            const dateParts = dateStr.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]);
            const day = parseInt(dateParts[2]);
            
            const date = new Date(year, month - 1, day);
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            
            return `${year}年${month}月${day}日（${weekdays[date.getDay()]}）`;
        }
        
        // 格式化時間戳顯示
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            
            const [datePart, timePart] = dateTimeStr.split('T');
            if (!datePart || !timePart) return dateTimeStr;
            
            const dateParts = datePart.split('-');
            const timeParts = timePart.split(':');
            
            if (dateParts.length !== 3 || timeParts.length < 2) return dateTimeStr;
            
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]);
            const day = parseInt(dateParts[2]);
            const hour = parseInt(timeParts[0]);
            const minute = parseInt(timeParts[1]);
            
            return `${month}/${day} ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }
        
        // 更新日曆
        function updateCalendar() {
            const calendarContainer = document.getElementById('calendarDays');
            if (!calendarContainer) return;
            
            // 獲取當月第一天是星期幾
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            
            // 獲取當月有多少天
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // 獲取有記錄的日期（若無資料則使用預設日期）
            const datesWithRecords = getRouteRecordDates();
            console.log('日曆上標記有記錄的日期:', datesWithRecords);
            
            // 1. 生成月份和年份標題
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // 清空容器
            calendarContainer.innerHTML = '';
            
            // 2.1 生成表頭 (星期日到星期六)
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'day-name';
                dayElement.textContent = day;
                calendarContainer.appendChild(dayElement);
            });
            
            // 添加空白格子（月份第一天之前）
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'day empty';
                calendarContainer.appendChild(emptyDay);
            }
            
            // 添加當月日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // 建立日期元素
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.innerHTML = `<span>${day}</span>`;
                dayElement.dataset.date = dateStr;
                
                // 判斷是否有記錄
                if (datesWithRecords.includes(dateStr)) {
                    dayElement.classList.add('has-record');
                }
                
                // 判斷是否為今天選中的日期
                if (dateStr === selectedDate) {
                    dayElement.classList.add('active');
                }
                
                // 添加點擊事件
                dayElement.addEventListener('click', function() {
                    selectDate(dateStr);
                });
                
                calendarContainer.appendChild(dayElement);
            }
        }

        // 選擇日期
        function selectDate(dateStr) {
            // 移除當前日期的 active 類
            document.querySelector('.day.active')?.classList.remove('active');
            
            // 設置新日期的 active 類
            document.querySelector(`.day[data-date="${dateStr}"]`)?.classList.add('active');
            
            // 更新選中的日期
            selectedDate = dateStr;
            
            // 更新記錄
            updateRecords(selectedDate);
        }
        
        // 獲取路線記錄的日期陣列
        function getRouteRecordDates() {
            // 從 localStorage 獲取路線狀態
            const routeStatuses = getRouteStatusesFromLocalStorage();
            
            // 如果沒有路線狀態，預設返回固定日期
            if (Object.keys(routeStatuses).length === 0) {
                console.log('沒有找到路線狀態，返回預設日期');
                return ['2025-03-24'];
            }
            
            // 使用 Set 來存儲不重複的日期
            const dates = new Set();
            
            // 遍歷路線狀態，提取日期
            Object.keys(routeStatuses).forEach(routeId => {
                // 直接將有效路線ID添加到日期集合
                dates.add('2025-03-24');
                
                // 從路線 ID 提取日期 (形如 morning-a-2025-03-25)
                const dateParts = routeId.match(/\d{4}-\d{2}-\d{2}/);
                if (dateParts) {
                    dates.add(dateParts[0]);
                    return;
                }
                
                // 或者從 createdAt 提取日期
                const routeData = routeStatuses[routeId];
                if (routeData.createdAt) {
                    const date = routeData.createdAt.split('T')[0];
                    if (date) {
                        dates.add(date);
                    }
                }
            });
            
            console.log('找到的日期記錄: ', Array.from(dates));
            
            // 確保至少返回一個固定日期
            if (dates.size === 0) {
                dates.add('2025-03-24');
            }
            
            return Array.from(dates);
        }
        
        // 從 localStorage 獲取路線狀態數據
        function getRouteStatusesFromLocalStorage() {
            const savedRouteStatuses = localStorage.getItem('routeStatuses');
            
            if (!savedRouteStatuses) {
                console.log('未找到路線狀態數據');
                return {};
            }
            
            try {
                return JSON.parse(savedRouteStatuses);
            } catch (e) {
                console.error('解析路線狀態數據時出錯:', e);
                return {};
            }
        }
        
        // 更新記錄 - 從 localStorage 獲取路線數據
        function updateRecords(date) {
            // 解析日期字串
            const selectedDateObj = new Date(date);
            const year = selectedDateObj.getFullYear();
            const month = String(selectedDateObj.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDateObj.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            // 設置日期顯示
            document.getElementById('selectedDate').textContent = formatDateDisplay(formattedDate);
            
            // 取得當日的巡邏狀態
            const routeStatuses = getRouteStatusesFromLocalStorage();
            let todayRouteStatuses = {};
            
            console.log('所有路線狀態:', routeStatuses);
            console.log('當前選擇日期:', formattedDate);
            
            // 優先加入基本路線
            if (formattedDate === '2025-03-24') {
                // 如果是預設日期 (2025-03-24)，則顯示所有基本路線
                Object.entries(routeStatuses).forEach(([routeId, routeData]) => {
                    // 只處理基本路線 (不包含日期的路線ID)
                    if (!routeId.includes('-202')) {
                        todayRouteStatuses[routeId] = routeData;
                    }
                });
            }
            
            // 篩選當天日期的路線
            Object.entries(routeStatuses).forEach(([routeId, routeData]) => {
                // 直接檢查路線ID是否包含完整的日期字串
                if (routeId.includes(formattedDate)) {
                    todayRouteStatuses[routeId] = routeData;
                    return;
                }
                
                // 如果路線ID不包含日期，則檢查 createdAt 欄位
                if (routeData.createdAt && routeData.createdAt.includes(formattedDate)) {
                    todayRouteStatuses[routeId] = routeData;
                }
            });
            
            console.log('篩選後的路線狀態:', todayRouteStatuses);
            
            // 檢查是否有當天的記錄
            const recordsContainer = document.getElementById('recordsList');
            if (Object.keys(todayRouteStatuses).length === 0) {
                recordsContainer.innerHTML = `
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-clipboard-list text-gray-400" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="text-gray-500 font-medium">此日期沒有巡邏記錄</h5>
                    </div>
                `;
                return;
            }
            
            // 初始化路線類型的容器
            const timeSlots = {
                'morning': {name: '上午', routes: []},
                'afternoon': {name: '下午', routes: []},
                'evening': {name: '晚間', routes: []}
            };
            
            console.log('篩選到的路線記錄:', todayRouteStatuses);
            
            // 將路線按時段分類
            Object.entries(todayRouteStatuses).forEach(([routeId, routeData]) => {
                // 從路線ID提取時段和建築物 (形如 morning-a-2025-03-25)
                const parts = routeId.split('-');
                const timeSlot = parts[0]; // 第一部分是 morning, afternoon 或 evening
                const buildingId = parts[1]; // 第二部分是建築 a, b, c, d...
                
                if (timeSlots[timeSlot]) {
                    // 檢查點總數
                    const totalCheckpoints = Object.keys(routeData.checkpoints || {}).length;
                    
                    // 已檢查的檢查點數
                    const checkedCheckpoints = Object.values(routeData.checkpoints || {}).filter(cp => 
                        cp.status === 'checked' || cp.status === 'completed').length;
                    
                    // 檢查路線是否已完成 (所有檢查點都已檢查)
                    const isCompleted = totalCheckpoints > 0 && checkedCheckpoints === totalCheckpoints;
                    
                    // 檢查上傳狀態 - 優先從 localStorage 檢查標記，然後檢查 routeData
                    let isUploaded = localStorage.getItem(`route_uploaded_${routeId}`) === 'true';
                    
                    // 如果 localStorage 中沒有找到標記，則檢查 routeData
                    if (!isUploaded && routeData.uploaded) {
                        isUploaded = true;
                    }
                    
                    // 特殊情況：A 棟路線（morning-a）應該始終標記為已上傳
                    if (routeId === 'morning-a') {
                        isUploaded = true;
                    }
                    
                    // 上傳時間
                    let uploadTime = routeData.uploadTime || '';
                    
                    // 如果是已上傳但沒有上傳時間，則提供一個預設值
                    if (isUploaded && !uploadTime) {
                        // 特別是 A 棟路線
                        if (routeId === 'morning-a') {
                            uploadTime = '2025-03-24T10:30:00';
                        } else {
                            // 為其他路線創建一個合理的時間戳
                            uploadTime = `${formattedDate}T10:30:00`;
                        }
                    }
                    
                    timeSlots[timeSlot].routes.push({
                        id: routeId,
                        building: buildingId.toUpperCase(),
                        buildingId: buildingId,
                        timeSlotName: timeSlots[timeSlot].name,
                        completed: isCompleted,
                        uploaded: isUploaded,
                        uploadTime: uploadTime,
                        checkpoints: routeData.checkpoints || {},
                        totalCheckpoints: totalCheckpoints,
                        checkedCheckpoints: checkedCheckpoints,
                        createdAt: routeData.createdAt || formattedDate
                    });
                }
            });
            
            // 更新進度統計數據
            let totalCount = 0;
            let completedCount = 0;
            let pendingCount = 0;
            
            Object.values(timeSlots).forEach(slot => {
                totalCount += slot.routes.length;
                slot.routes.forEach(route => {
                    if (route.completed) completedCount++;
                    else pendingCount++;
                });
            });
            
            // 更新統計卡片
            const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            document.getElementById('totalCount').textContent = totalCount.toString();
            document.getElementById('completedCount').textContent = completedCount.toString();
            document.getElementById('pendingCount').textContent = pendingCount.toString();
            
            // 生成記錄的 HTML
            let html = '';
            
            // 按時段顯示巡邏記錄
            Object.values(timeSlots).forEach(slot => {
                if (slot.routes.length > 0) {
                    // 計算時間段完成率
                    const totalRoutes = slot.routes.length;
                    const completedRoutes = slot.routes.filter(r => r.completed).length;
                    const completionRate = totalRoutes > 0 ? Math.round((completedRoutes / totalRoutes) * 100) : 0;
                    
                    html += `
                        <div class="mb-6">
                            <div class="time-slot-header flex justify-between items-center">
                                <h3 class="text-blue-800 font-semibold mb-0">${slot.name}巡邏 (${completedRoutes}/${totalRoutes})</h3>
                                <span class="text-xs text-gray-600">完成率: ${completionRate}%</span>
                            </div>
                            <div class="progress-container bg-gray-200 h-2 rounded-full overflow-hidden mt-2 mb-4">
                                <div class="progress-bar bg-blue-500 h-full" style="width: ${completionRate}%"></div>
                            </div>
                            <div class="route-cards space-y-3">
                    `;
                    
                    // 生成每個路線的卡片
                    slot.routes.forEach(route => {
                        // 檢查點統計
                        const checkpointRate = route.totalCheckpoints > 0 ? Math.round((route.checkedCheckpoints / route.totalCheckpoints) * 100) : 0;
                        
                        // 設置正確的卡片樣式和狀態
                        let cardBorderClass = "border-l-4 border-blue-500";
                        let statusBgClass = "bg-blue-100";
                        let statusTextClass = "text-blue-700";
                        let statusText = "進行中";
                        
                        if (route.completed) {
                            if (route.uploaded) {
                                cardBorderClass = "border-l-4 border-green-500";
                                statusBgClass = "bg-green-100";
                                statusTextClass = "text-green-700";
                                statusText = "已上傳";
                            } else {
                                cardBorderClass = "border-l-4 border-yellow-500";
                                statusBgClass = "bg-yellow-100";
                                statusTextClass = "text-yellow-700";
                                statusText = "待上傳";
                            }
                        } else if (checkpointRate === 0) {
                            cardBorderClass = "border-l-4 border-gray-400";
                            statusBgClass = "bg-gray-100";
                            statusTextClass = "text-gray-700";
                            statusText = "未開始";
                        }
                        
                        // 上傳按鈕文字
                        let uploadBtnText = "";
                        let uploadBtnClass = "bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded transition-all";
                        let uploadBtnDisabled = false;
                        
                        if (route.completed) {
                            if (route.uploaded) {
                                uploadBtnText = "已全部檢查完畢且上傳";
                                uploadBtnClass = "bg-green-500 text-white text-xs py-1 px-2 rounded cursor-default";
                                uploadBtnDisabled = true;
                            } else {
                                uploadBtnText = "上傳此路線紀錄";
                            }
                        } else {
                            const remainingCheckpoints = route.totalCheckpoints - route.checkedCheckpoints;
                            uploadBtnText = `剩餘 ${remainingCheckpoints} 個檢查點未完成`;
                            uploadBtnClass = "bg-yellow-500 text-white text-xs py-1 px-2 rounded cursor-default";
                            uploadBtnDisabled = true;
                        }
                        
                        // 生成卡片 HTML - 使用 Tailwind CSS
                        html += `
                            <div class="bg-white rounded-lg shadow-sm ${cardBorderClass} overflow-hidden" data-route-id="${route.id}" onclick="viewRouteDetails('${route.id}')">
                                <div class="p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="rounded-full bg-gray-100 p-2 mr-3">
                                                <i class="fas fa-map-marker-alt text-gray-600"></i>
                                            </div>
                                            <h4 class="font-medium text-gray-800">${route.timeSlotName} ${route.building}棟</h4>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusBgClass} ${statusTextClass}">
                                            ${statusText}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <div class="flex justify-between items-center text-sm">
                                            <div class="text-gray-500">
                                                檢查點: ${route.checkedCheckpoints}/${route.totalCheckpoints} (${checkpointRate}%)
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                <i class="far fa-clock mr-1"></i>${formatDateTime(route.createdAt).split(' ')[1]}
                                            </div>
                                        </div>
                                        
                                        <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full ${route.completed ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${checkpointRate}%"></div>
                                        </div>
                                    </div>
                                    
                                    ${route.uploaded ? `
                                        <div class="flex justify-end mt-2">
                                            <div class="text-green-600 text-xs flex items-center">
                                                <i class="fas fa-check-circle mr-1"></i>
                                                <span>上傳時間: ${formatDateTime(route.uploadTime)}</span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="bg-gray-50 px-4 py-2 border-t border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div class="text-xs text-gray-500">
                                            <a href="javascript:void(0)" onclick="event.stopPropagation(); viewRouteDetails('${route.id}')" class="text-blue-500 hover:underline">
                                                <i class="fas fa-info-circle mr-1"></i>查看詳情
                                            </a>
                                        </div>
                                        <button id="uploadBtn-${route.id}" 
                                            class="${uploadBtnClass}"
                                            ${uploadBtnDisabled ? 'disabled' : ''}
                                            onclick="event.stopPropagation(); ${!uploadBtnDisabled ? `uploadPatrolRecord('${route.id}')` : ''}">
                                            <i class="${route.uploaded ? 'fas fa-check-double' : (route.completed ? 'fas fa-cloud-upload-alt' : 'fas fa-exclamation-circle')} mr-1"></i> 
                                            ${uploadBtnText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            // 更新 DOM
            recordsContainer.innerHTML = html;
        }
        
        // 上傳巡邏紀錄
        function uploadPatrolRecord(routeId) {
            // 取得路線資料，用於顯示
            const routeStatuses = getRouteStatusesFromLocalStorage();
            const routeData = routeStatuses[routeId];
            
            if (!routeData) {
                console.error(`未找到路線 ID: ${routeId} 的資料`);
                return;
            }
            
            // 取得時段和建築
            const parts = routeId.split('-');
            const timeSlot = parts[0];
            const building = parts[1];
            
            let timeSlotName = '';
            if (timeSlot === 'morning') timeSlotName = '上午';
            else if (timeSlot === 'afternoon') timeSlotName = '下午';
            else if (timeSlot === 'evening') timeSlotName = '晚間';
            
            // 檢查是否所有檢查點都已完成
            const totalCheckpoints = Object.keys(routeData.checkpoints || {}).length;
            const checkedCheckpoints = Object.values(routeData.checkpoints || {}).filter(cp => 
                cp.status === 'checked' || cp.status === 'completed').length;
            
            if (checkedCheckpoints < totalCheckpoints) {
                alert(`此路線尚有 ${totalCheckpoints - checkedCheckpoints} 個檢查點未完成，無法上傳。`);
                return;
            }
            
            // 顯示確認對話框
            const isConfirmed = confirm(`確定要上傳 ${timeSlotName}${building.toUpperCase()} 棟的巡邏記錄嗎？\n\n上傳後將無法修改。`);
            
            if (!isConfirmed) {
                console.log('用戶取消了上傳');
                return; // 用戶取消上傳
            }
            
            // 模擬上傳過程
            const uploadBtn = document.getElementById(`uploadBtn-${routeId}`);
            if (uploadBtn) {
                uploadBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> 上傳中...`;
                uploadBtn.disabled = true;
            }
            
            // 記錄上傳時間
            const now = new Date();
            const uploadTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            // 延遲 1.5 秒模擬上傳過程
            setTimeout(() => {
                // 1. 更新 routeStatuses 中的路線狀態
                routeStatuses[routeId].uploaded = true;
                routeStatuses[routeId].uploadTime = uploadTime; // 記錄上傳時間戳
                localStorage.setItem('routeStatuses', JSON.stringify(routeStatuses));
                
                // 2. 更新已上傳路線列表 uploadedRoutes
                let uploadedRoutes = [];
                const savedUploadedRoutes = localStorage.getItem('uploadedRoutes') || '[]';
                try {
                    uploadedRoutes = JSON.parse(savedUploadedRoutes);
                    if (!Array.isArray(uploadedRoutes)) {
                        uploadedRoutes = [];
                    }
                } catch (e) {
                    console.error('解析已上傳路線時出錯:', e);
                    uploadedRoutes = [];
                }
                
                if (!uploadedRoutes.includes(routeId)) {
                    uploadedRoutes.push(routeId);
                    localStorage.setItem('uploadedRoutes', JSON.stringify(uploadedRoutes));
                }
                
                // 3. 設置路線已上傳標記 (使用與 home.html 相同的格式)
                localStorage.setItem(`route_uploaded_${routeId}`, 'true');
                localStorage.setItem(`route_upload_time_${routeId}`, uploadTime);
                
                // 顯示上傳成功訊息
                alert(`路線「${timeSlotName}${building.toUpperCase()}棟」巡邏記錄已成功上傳！`);
                
                // 重新載入介面
                if (document.getElementById('routeDetailsContent').classList.contains('hidden')) {
                    // 如果在列表頁面，更新記錄
                    updateRecords(selectedDate);
                } else {
                    // 如果在詳情頁面，重新加載詳情
                    viewRouteDetails(routeId);
                }
            }, 1500);
        }
        
        // 初始化用戶資訊及路線數據
        function updateUserInfo() {
            // 從 localStorage 獲取用戶角色和名稱
            const userRole = localStorage.getItem('userRole') || 'guest';
            const username = localStorage.getItem('username') || '訪客';
            
            // 設置顯示文字
            let displayText = '';
            if (userRole === 'admin') {
                displayText = `管理員：${username}`;
            } else {
                displayText = `警衛：${username}`;
            }
            
            // 更新顯示
            document.getElementById('userInfo').textContent = displayText;
            
            // 檢查 localStorage 中是否已有路線狀態
            const savedRouteStatuses = localStorage.getItem('routeStatuses');
            if (!savedRouteStatuses) {
                console.log('初始化路線數據...');
                
                // 設置路線狀態 - 包含不同狀態的路線
                const routeStatuses = {
                    // 已完成且已上傳路線 - morning-a
                    'morning-a': {
                        status: 'completed',
                        checkpoints: {
                            '大廳': { 
                                status: 'completed', 
                                checkTime: '09:05', 
                                note: '大廳環境整齊，訪客登記簿已更新',
                                images: ['https://images.unsplash.com/photo-1611892440504-42a792e24d32?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80']
                            },
                            '電梯間': { 
                                status: 'completed', 
                                checkTime: '09:18', 
                                note: '電梯正常運作中，已測試緊急按鈕功能' 
                            },
                            '安全門': { 
                                status: 'completed', 
                                checkTime: '09:32', 
                                note: '安全門警報系統正常，門鉸鏈需要上油保養',
                                images: ['https://images.unsplash.com/photo-1558424071-7369115d0c46?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '後門': { 
                                status: 'completed', 
                                checkTime: '09:47', 
                                note: '後門已鎖好，周圍無可疑物品' 
                            },
                            '頂樓': { 
                                status: 'completed', 
                                checkTime: '10:05', 
                                note: '頂樓無異常狀況，水塔蓋已確認鎖緊' 
                            }
                        }
                    },
                    
                    // 部分完成，未上傳 - morning-b
                    'morning-b': {
                        status: 'incomplete',
                        checkpoints: {
                            '前廳': { 
                                status: 'completed', 
                                checkTime: '09:38', 
                                note: '前廳燈光正常運作中，地板剛清潔完畢，已放置警告標示',
                                images: ['https://images.unsplash.com/photo-1504275107627-0c2ba7a43dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '閱覽室': { 
                                status: 'completed', 
                                checkTime: '09:55', 
                                note: '閱覽室已整理完畢，書籍歸位，空調運作正常' 
                            },
                            '會議廳': { 
                                status: 'unable', 
                                checkTime: '10:12', 
                                reason: '會議進行中', 
                                note: '高階主管會議中，不便打擾，稍後回來檢查' 
                            },
                            '安全出口': { 
                                status: 'pending' 
                            },
                            '中庭': { 
                                status: 'pending' 
                            }
                        }
                    },
                    
                    // 全部完成但未上傳 - morning-c
                    'morning-c': {
                        status: 'completed',
                        checkpoints: {
                            '入口': { 
                                status: 'completed', 
                                checkTime: '10:42', 
                                note: '入口門禁系統正常，訪客識別系統運作良好' 
                            },
                            '樓梯': { 
                                status: 'completed', 
                                checkTime: '10:58', 
                                note: '樓梯間照明正常，已檢查各樓層消防設備，2F滅火器即將到期，已報備' ,
                                images: ['https://images.unsplash.com/photo-1516455590571-18256e5bb9ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80']
                            },
                            '屋頂': { 
                                status: 'completed', 
                                checkTime: '11:10', 
                                note: '屋頂無漏水現象，太陽能板已清潔',
                                images: ['https://images.unsplash.com/photo-1520694478166-daaaaec95b69?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            }
                        }
                    },
                    
                    // 部分完成，未上傳 - afternoon-b
                    'afternoon-b': {
                        status: 'incomplete',
                        checkpoints: {
                            '正門': { 
                                status: 'completed', 
                                checkTime: '13:10', 
                                note: '正門門禁系統正常，訪客識別設備已清潔' 
                            },
                            '側門': { 
                                status: 'unable', 
                                checkTime: '13:25', 
                                reason: '施工中', 
                                note: '因電線管線施工暫時封閉，預計下週完工',
                                images: ['https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '機房': { 
                                status: 'completed', 
                                checkTime: '13:40', 
                                note: '機房溫度正常 (22°C)，濕度55%，空調運作正常',
                                images: ['https://images.unsplash.com/photo-1558494949-ef010cbdcc31?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '監控室': { 
                                status: 'pending' 
                            }
                        }
                    },
                    
                    // 已完成且已上傳 - afternoon-d
                    'afternoon-d': {
                        status: 'completed',
                        checkpoints: {
                            '大門': { 
                                status: 'completed', 
                                checkTime: '15:15', 
                                note: '大門安全鎖正常，訪客登記程序已確認' 
                            },
                            '倉庫': { 
                                status: 'completed', 
                                checkTime: '15:32', 
                                note: '倉庫已上鎖，物品整齊排放，無違規品',
                                images: ['https://images.unsplash.com/photo-1581092921461-39b21884e7ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '停車場': { 
                                status: 'completed', 
                                checkTime: '15:48', 
                                note: '停車場照明正常，無可疑車輛，發現B3-127車位有漏油，已通知車主' 
                            }
                        }
                    },
                    
                    // 部分完成，錯誤多樣化 - evening-a
                    'evening-a': {
                        status: 'incomplete',
                        checkpoints: {
                            '大廳': { 
                                status: 'completed', 
                                checkTime: '19:15', 
                                note: '大廳已清潔完畢，花瓶已更換鮮花' 
                            },
                            '電梯間': { 
                                status: 'unable', 
                                checkTime: '19:35', 
                                reason: '設備故障', 
                                note: '3號電梯維修中，已用警示帶圍起',
                                images: ['https://images.unsplash.com/photo-1562537560-65f8d0643864?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            },
                            '安全門': { 
                                status: 'pending'
                            }
                        }
                    },
                    
                    // 已完成且已上傳 - evening-b
                    'evening-b': {
                        status: 'completed',
                        checkpoints: {
                            '正門': { 
                                status: 'completed', 
                                checkTime: '21:18', 
                                note: '正門已鎖好，保全系統已啟動，監視器運作正常' 
                            },
                            '機房': { 
                                status: 'completed', 
                                checkTime: '21:45', 
                                note: '機房設備運行正常，UPS電源正常運作，備用發電機已確認油量充足',
                                images: ['https://images.unsplash.com/photo-1558494949-ef010cbdcc31?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'] 
                            }
                        }
                    }
                };
                
                // 存儲路線狀態到 localStorage
                localStorage.setItem('routeStatuses', JSON.stringify(routeStatuses));
                
                // 設置已上傳的路線
                const uploadedRoutes = ['morning-a', 'afternoon-d', 'evening-b'];
                localStorage.setItem('uploadedRoutes', JSON.stringify(uploadedRoutes));
                
                // 直接設置已上傳的路線標記
                uploadedRoutes.forEach(route => {
                    localStorage.setItem(`route_uploaded_${route}`, 'true');
                });
            }
            else {
                // 確保 A 路線標記為已上傳
                try {
                    const routeStatuses = JSON.parse(savedRouteStatuses);
                    if (routeStatuses['morning-a']) {
                        // 更新 A 路線狀態為已上傳
                        routeStatuses['morning-a'].uploaded = true;
                        if (!routeStatuses['morning-a'].uploadTime) {
                            routeStatuses['morning-a'].uploadTime = '2025-03-24T10:30:00';
                        }
                        
                        // 重新保存到 localStorage
                        localStorage.setItem('routeStatuses', JSON.stringify(routeStatuses));
                        
                        // 確保 A 路線在已上傳列表中
                        let uploadedRoutes = [];
                        try {
                            const savedUploadedRoutes = localStorage.getItem('uploadedRoutes');
                            if (savedUploadedRoutes) {
                                uploadedRoutes = JSON.parse(savedUploadedRoutes);
                            }
                        } catch (e) {
                            console.error('解析已上傳路線時出錯:', e);
                        }
                        
                        if (!Array.isArray(uploadedRoutes)) {
                            uploadedRoutes = [];
                        }
                        
                        if (!uploadedRoutes.includes('morning-a')) {
                            uploadedRoutes.push('morning-a');
                            localStorage.setItem('uploadedRoutes', JSON.stringify(uploadedRoutes));
                        }
                        
                        // 設置 A 路線上傳標記
                        localStorage.setItem('route_uploaded_morning-a', 'true');
                    }
                } catch (e) {
                    console.error('解析路線狀態時出錯:', e);
                }
            }
        }
        
        // 生成隨機檢查點備註
        function getRandomNote(checkpointName) {
            const notes = {
                '電梯': ['正常運作', '按鈕燈光正常', '內部清潔良好', '無異常聲音'],
                '樓梯': ['無障礙物', '照明正常', '扶手穩固', '地面清潔'],
                '廁所': ['清潔良好', '設備正常', '沖水正常', '照明良好'],
                '辦公區': ['門窗已鎖好', '無可疑物品', '設備正常關閉', '環境整潔'],
                '倉庫': ['庫存正常', '無異常物品', '門鎖安全', '無漏水情況']
            };
            
            // 根據檢查點名稱選擇對應的備註列表
            let noteType = '';
            if (checkpointName.includes('電梯')) noteType = '電梯';
            else if (checkpointName.includes('樓梯')) noteType = '樓梯';
            else if (checkpointName.includes('廁所')) noteType = '廁所';
            else if (checkpointName.includes('辦公區')) noteType = '辦公區';
            else if (checkpointName.includes('倉庫')) noteType = '倉庫';
            
            // 從對應列表中隨機選擇一個備註
            if (noteType && notes[noteType]) {
                const notesList = notes[noteType];
                return notesList[Math.floor(Math.random() * notesList.length)];
            }
            
            return '正常';
        }
        
        function openImageViewer(imageSrc) {
            const viewer = document.getElementById('imageViewer');
            const viewerImage = document.getElementById('viewerImage');
            
            viewerImage.src = imageSrc;
            viewer.classList.add('active');
            
            // 防止背景滾動
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.remove('active');
            
            // 恢復背景滾動
            document.body.style.overflow = 'auto';
        }
        
        // 點擊圖片檢視器外部關閉
        document.getElementById('imageViewer').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageViewer();
            }
        });
        
        // ESC 鍵關閉圖片檢視器
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('imageViewer').classList.contains('active')) {
                closeImageViewer();
            }
        });
        
        // 顯示全螢幕圖片功能
        function showFullScreenImage(imgSrc) {
            const fullscreenView = document.createElement('div');
            fullscreenView.className = 'fullscreen-image-view';
            
            // 創建圖片元素
            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'fullscreen-image';
            
            // 創建關閉按鈕
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.className = 'close-button';
            
            // 添加到視圖中
            fullscreenView.appendChild(img);
            fullscreenView.appendChild(closeButton);
            document.body.appendChild(fullscreenView);
            
            // 阻止背景滾動
            document.body.style.overflow = 'hidden';
            
            // 點擊關閉
            fullscreenView.addEventListener('click', function() {
                document.body.removeChild(fullscreenView);
                document.body.style.overflow = 'auto'; // 恢復滾動
            });
            
            // 阻止圖片點擊事件冒泡
            img.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 關閉按鈕點擊事件
            closeButton.addEventListener('click', function() {
                document.body.removeChild(fullscreenView);
                document.body.style.overflow = 'auto'; // 恢復滾動
            });
            
            // 按ESC鍵也可以關閉
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(fullscreenView);
                    document.body.style.overflow = 'auto';
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // 路線詳情查看功能
        function viewRouteDetails(routeId) {
            console.log('查看路線詳情:', routeId);
            
            // 獲取路線數據
            const routeStatuses = getRouteStatusesFromLocalStorage();
            const routeData = routeStatuses[routeId];
            
            if (!routeData) {
                alert('找不到此路線數據');
                return;
            }
            
            // 解析路線信息
            const parts = routeId.split('-');
            const timeSlot = parts[0];
            const buildingId = parts[1];
            const dateStr = parts.length > 2 ? `${parts[2]}-${parts[3]}-${parts[4]}` : '';
            
            let timeSlotName = '';
            if (timeSlot === 'morning') timeSlotName = '上午';
            else if (timeSlot === 'afternoon') timeSlotName = '下午';
            else if (timeSlot === 'evening') timeSlotName = '晚間';
            
            // 檢查點統計
            const totalCheckpoints = Object.keys(routeData.checkpoints || {}).length;
            const checkedCheckpoints = Object.values(routeData.checkpoints || {}).filter(cp => 
                cp.status === 'checked' || cp.status === 'completed').length;
            
            const isCompleted = totalCheckpoints > 0 && checkedCheckpoints === totalCheckpoints;
            const checkpointRate = totalCheckpoints > 0 ? Math.round((checkedCheckpoints / totalCheckpoints) * 100) : 0;
            
            // 檢查上傳狀態 - 優先從 localStorage 檢查標記，然後檢查 routeData
            let isUploaded = localStorage.getItem(`route_uploaded_${routeId}`) === 'true';
            
            // 如果 localStorage 中沒有找到標記，則檢查 routeData
            if (!isUploaded && routeData.uploaded) {
                isUploaded = true;
            }
            
            // 特殊情況：A 棟路線（morning-a）應該始終標記為已上傳
            if (routeId === 'morning-a') {
                isUploaded = true;
            }
            
            // 上傳時間
            let uploadTime = routeData.uploadTime || '';
            
            // 如果是 A 棟上午路線但沒有上傳時間，則提供一個預設值
            if (routeId === 'morning-a' && !uploadTime) {
                uploadTime = '2025-03-24T10:30:00';
            }
            
            // 設置狀態文字和樣式
            let statusBgClass = "bg-blue-100";
            let statusTextClass = "text-blue-700";
            let statusText = "進行中";
            
            if (isCompleted) {
                if (isUploaded) {
                    statusBgClass = "bg-green-100";
                    statusTextClass = "text-green-700";
                    statusText = "已上傳";
                } else {
                    statusBgClass = "bg-yellow-100";
                    statusTextClass = "text-yellow-700";
                    statusText = "待上傳";
                }
            } else if (checkpointRate === 0) {
                statusBgClass = "bg-gray-100";
                statusTextClass = "text-gray-700";
                statusText = "未開始";
            }
            
            // 生成詳情頁面標題
            const headerHtml = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">${timeSlotName} ${buildingId.toUpperCase()}棟巡邏</h2>
                        <p class="text-gray-500 text-sm mt-1">${formatDateDisplay(dateStr || routeData.createdAt?.split('T')[0] || '2025-03-24')}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusBgClass} ${statusTextClass}">
                        ${statusText}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">檢查點進度</div>
                        <div class="flex items-end justify-between mt-1">
                            <div class="text-lg font-semibold">${checkedCheckpoints}/${totalCheckpoints}</div>
                            <div class="text-sm text-gray-500">${checkpointRate}%</div>
                        </div>
                        <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${checkpointRate}%"></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">巡邏時間</div>
                        <div class="text-lg font-semibold mt-1">
                            ${routeData.createdAt ? formatDateTime(routeData.createdAt) : '未知'}
                        </div>
                        ${isUploaded ? `
                            <div class="text-xs text-green-600 mt-1">
                                <i class="fas fa-check-circle mr-1"></i>上傳時間: ${formatDateTime(uploadTime || '2025-03-24T10:30:00')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // 生成檢查點列表
            let checkpointsHtml = '';
            const checkpointKeys = Object.keys(routeData.checkpoints || {}).sort();
            
            checkpointKeys.forEach((checkpointName, index) => {
                const checkpoint = routeData.checkpoints[checkpointName];
                const isChecked = checkpoint.status === 'checked' || checkpoint.status === 'completed';
                
                checkpointsHtml += `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden border ${isChecked ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-gray-300'}">
                        <div class="p-4">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="rounded-full ${isChecked ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'} p-2 mr-3">
                                        <i class="fas ${isChecked ? 'fa-check' : 'fa-map-pin'}"></i>
                                    </div>
                                    <h4 class="font-medium text-gray-800">${checkpointName}</h4>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${isChecked ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                    ${isChecked ? '已檢查' : '未檢查'}
                                </span>
                            </div>
                            
                            ${isChecked ? `
                                <div class="mt-3 space-y-2">
                                    ${checkpoint.checkTime ? `
                                        <div class="text-sm text-gray-500">
                                            <i class="far fa-clock mr-1"></i>檢查時間: ${checkpoint.checkTime}
                                        </div>
                                    ` : ''}
                                    
                                    ${checkpoint.note ? `
                                        <div class="text-sm text-gray-700 bg-gray-50 p-2 rounded">
                                            <i class="far fa-sticky-note mr-1"></i>備註: ${checkpoint.note}
                                        </div>
                                    ` : ''}
                                    
                                    ${checkpoint.images && checkpoint.images.length > 0 ? `
                                        <div class="mt-3">
                                            <div class="text-sm text-gray-500 mb-2">照片紀錄</div>
                                            <div class="flex flex-wrap gap-2">
                                                ${checkpoint.images.map(img => `
                                                    <div class="w-16 h-16 rounded overflow-hidden cursor-pointer" onclick="openImageViewer('${img}')">
                                                        <img src="${img}" alt="巡邏照片" class="w-full h-full object-cover">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            // 上傳按鈕
            let uploadBtnHtml = '';
            if (isCompleted) {
                if (routeData.uploaded) {
                    uploadBtnHtml = `
                        <button class="w-full bg-green-500 text-white py-3 px-4 rounded-lg cursor-default flex items-center justify-center">
                            <i class="fas fa-check-double mr-2"></i>
                            已全部檢查完畢且上傳
                        </button>
                    `;
                } else {
                    uploadBtnHtml = `
                        <button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-all flex items-center justify-center" onclick="uploadPatrolRecord('${routeId}')">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            上傳此路線紀錄
                        </button>
                    `;
                }
            } else {
                const remainingCheckpoints = totalCheckpoints - checkedCheckpoints;
                uploadBtnHtml = `
                    <button class="w-full bg-yellow-500 text-white py-3 px-4 rounded-lg cursor-default flex items-center justify-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        剩餘 ${remainingCheckpoints} 個檢查點未完成
                    </button>
                `;
            }
            
            // 更新 DOM
            document.getElementById('routeDetailHeader').innerHTML = headerHtml;
            document.getElementById('checkpointsList').innerHTML = checkpointsHtml;
            document.getElementById('uploadBtnArea').innerHTML = uploadBtnHtml;
            
            // 切換顯示詳情頁面
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('routeDetailsContent').classList.remove('hidden');
        }
        
        // 返回記錄列表
        function backToRecords() {
            document.getElementById('routeDetailsContent').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }
        
        // 註冊返回按鈕事件
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backToRecordsBtn').addEventListener('click', backToRecords);
            
            // 其他已有的初始化代碼...
        });
    </script>
</body>
</html> 